<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贺卡展示</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/showCover.css" />
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/jquery.qrcode.min.js"></script>
    <script src="js/html2canvas.js"></script>
    <link rel="stylesheet" type="text/css" href="css/loading.css">
    <style type="text/css">
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 100;
        }

        .loading .pic {
            width: 64px;
            height: 64px;
            /* border: 1px solid #900; */
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            margin: auto;

        }
    </style>
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <script>
        // 通过加载状态来显示进度条
        document.onreadystatechange = function () {
            if (document.readyState == "complete") {
                $(".loading").fadeOut();
            }
        }
    </script>
</head>

<body>
    <div class="loading lds-css ng-scope">
        <div style="width:100%;height:100%" class="pic lds-pacman">
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div>
                <div></div>
                <div></div>
            </div>
        </div>
    </div>

    <img src="" class="image">


    <div class="section">
        <div class="pic">
            <img src="" alt="" class="relic">
            <img src="" alt="" class="shade">
            <img src="" alt="" class="word">
        </div>
        <div class="blessing">
            <img src="" alt="" class="bless">
            <div class="canvas"></div>
            <span id="code"></span>
        </div>

    </div>
    <div class="final">
    </div>
    <div class="alt">快快长按贺卡图片，保存贺卡或发送给朋友吧</div>
</body>
<script>
    var cardId = location.search.substr(1).split('=')[1];
    var url = 'https://wendysong183.github.io/NewYearCard/showReverse.html?cardId=' + cardId;
    console.log(url);

    jQuery('.canvas').qrcode({
        // render: "image",
        width: 160,
        height: 160,
        background: 'transparent',
        foreground: "#ae4742",
        // background: "#ae4742", //二维码的后景色
        // foreground: "transparent", //二维码的前景色
        text: url,
        scale: 2,

    });
    var cover = document.querySelector('.section');
    var img = document.querySelector('.image');
    var final = document.querySelector('.final');
    var relicId = 11;
    var relicsrc;
    var wordsrc;
    var shade;
    var shadesrc;
    var blesssrc;

    $(function () {

        $.post("https://wx.weibenh5.com/2020/Dec/yearCard/api/api.php?a=details", {
            id: cardId,
        },
            function (data, status) {
                console.log(data, status);


                relicId = data.data.title;
                wordsrc = data.data.blessing;
                relicsrc = 'image/a_' + relicId + '.png';
                shade = wordsrc.split('/')[1].split('_')[0];
                shadesrc = 'image/' + shade + '.png';
                blesssrc = 'image/d_' + parseInt(relicId / 10) + '.png';
                console.log(shade);
                $('.relic').attr('src', relicsrc);
                $('.shade').attr('src', shadesrc);
                $('.word').attr('src', wordsrc);
                $('.bless').attr('src', blesssrc);
                // window.location.reload()
                $('.alt').ready(function () {
                    console.log(1);

                    html2canvas(cover, {
                        scale: 2,
                        width: 320,
                    }).then(canvas => {
                        final.appendChild(canvas)
                        setTimeout(() => {
                            var imgUrl = canvas.toDataURL("image/png"); // 将canvas转换成img的src流
                            console.log("base64编码数据：", imgUrl);
                            img.src = imgUrl;
                        }, 0)
                        cover.style.display = 'none';
                        final.style.display = 'none';
                    });
                })
            });

    })
</script>

</html>