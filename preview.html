<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,minimun-scale=1.0,maximum-scale=1.0,user-scable=no">
    <title>预览</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/preview.css">

    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/html2canvas.js"></script>
</head>

<body>
    <section>
        <div class="cover">
            <img src="" alt="" class="bg1">
            <img src="" alt="" class="bg2">
            <img src="" alt="" class="bg3">
            <img src="image/erweima.png" alt="" class="bg4">
            <p class="title"></p>
        </div>
        <div class="reverse">
            <div class="inherit">
                <img src="image/xa_1.png" alt="" class="cultural">
                <img src="image/xc_2.png" alt="" class="postmark">
            </div>
            <div class="section">
                <p class="row"></p>
                <p class="row"></p>
                <p class="row"></p>
                <p class="row"></p>
                <p class="row"></p>
            </div>
        </div>
    </section>
    <div class="link">
        <label for="checkbox"><input type="checkbox" id="checkbox" checked>发送到良博祝福墙</label>

        <button class=".btn finish">完成</button>
        <!-- <button class=".btn submit">发送到祝福墙</button> -->
    </div>
    <div><img class="image" src="" /></div>
    <!-- <div class="btn_ares">
        <a href="showCover.html" class="btn">完成</a>
        <a href="#" class="btn">发送到良博祝福墙</a>
    </div> -->
    <script>
        var bg1 = document.querySelector('.bg1');
        var bg2 = document.querySelector('.bg2');
        var bg3 = document.querySelector('.bg3');
        var title = document.querySelector('.title');


        var arr = location.search.substr(1).split('&');
        var obj = new Object();
        for (var i = 0; i < arr.length; i++) {
            var tmp_arr = arr[i].split('=')
            obj[decodeURIComponent(tmp_arr[0])] = decodeURIComponent(tmp_arr[1]);

        }
        title.innerHTML = obj['title'];
        var myTitle= obj['title'];
        console.log(myTitle);
        // recipient.innerHTML = obj['recipient'];
        // content.innerHTML = obj['content'];
        // sender.innerHTML = obj['sender'];
        bg2.src = 'image/' + obj['selected_bg1'];
        bg1.src = 'image/' + obj['selected_bg2'];
        bg3.src = 'image/' + obj['selected_bg3'];
        var cultural = document.querySelector('.cultural');
        var postmark = document.querySelector('.postmark');
        var checkbox = document.querySelector('#checkbox');
        var rows = document.querySelectorAll('.row');
        cultural.src = 'image/x' + obj['selected_bg1'];
        postmark.src = 'image/x' + obj['selected_bg3'];
        console.log(checkbox.checked);
        var type;
        checkbox.addEventListener('click',function(){
            type=checkbox.checked?1:2;
        
        })
        console.log('ttt',type);

        // row.innerHTML = obj['content'].replace('\n','<br>');
        var content=obj['content'].replace(/\+/g, '&nbsp');
        text = obj['content'].split('\n');
        console.log(content);
        for (var i = 0; i < text.length; i++) {
            rows[i].innerHTML = text[i].replace(/\+/g, '&nbsp');
        }
        var imgUrlId = obj['selected_bg1'].split('.')[0].split('_')[1] + obj['selected_bg2'].split('.')[0].split('_')[1] + obj['selected_bg3'].split('.')[0].split('_')[1];
        console.log(imgUrlId);


        $(document).ready(function() {
            $(".finish").click(function() {
                var checkbox = document.querySelector('#checkbox');
                var type=checkbox.checked?1:2;
                console.log("wg",type);
                
                $.post("https://wx.weibenh5.com/2020/Dec/yearCard/api/api.php?a=submits", {
                        title: myTitle,
                        content: content,
                        recipient: 's',
                        blessing: 's',
                        sender: 's',
                        type: type,
                        img_url_id: imgUrlId,
                    },
                    function(data, status) {
                        console.log(data, status);
                        // alert(alertText);

                    });
            });
        });




        var cover = document.querySelector('.cover');
        var img = document.querySelector('.image');
        html2canvas(cover, {
            scale: 2,
        }).then(canvas => {
            document.body.appendChild(canvas)
            setTimeout(() => {
                var imgUrl = canvas.toDataURL("image/png"); // 将canvas转换成img的src流
                console.log("base64编码数据：", imgUrl);
            }, 0)

        //     // console.log(canvas.toDataURL('png'));
        //     //img.src=canvas.toDataURL();
        //     //document.body.appendChild(canvas)
        });
    </script>
</body>


</html>